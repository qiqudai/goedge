# CDN Configuration Spec (Draft)

## 1. Defaulting & Override Rules

1) 系统默认（管理员配置，global scope）
- 只用于用户注册后的默认值和“无用户默认”时的兜底。
- 存储在 `config` 表（scope_name = global, scope_id = 0）。

2) 用户默认（用户配置）
- 用户创建站点/转发时优先使用用户默认配置。
- 仅当用户默认缺失时，回退到系统默认。
- 建议存储在 `config` 表（scope_name = user, scope_id = <uid>）。

3) 站点/转发级配置
- 站点/转发上的显式配置最高优先级。

优先级：站点/转发覆盖 > 用户默认 > 系统默认

## 2. 配置同步策略（目标）

目标：中心配置能快速增量同步到所有节点，减少节点负担。

推荐：增量版本号 + Redis 通知，节点拉取差量；保底全量拉取。

- 配置版本：每个资源（site/stream/cc/acl 等）生成版本号，合并成节点级版本。
- 发布：中心写入 Redis Pub/Sub 通知（`config:changed`），节点收到后仅拉取更新版本。
- 保底：节点定时拉取（例如 60s），比较版本不一致则全量同步。

## 3. 数据表与配置用途（持续补全）

### 核心资源
- `user`：用户主体信息、认证、余额、白名单、登录安全等。
- `package`/`user_package`：套餐定义 / 用户已购套餐实例。
- `site`：网站（L7 CDN）主配置。
- `stream`：四层转发主配置。
- `cert`/`dnsapi`：证书与 DNS API。
- `acl`/`cc_rule`/`cc_match`/`cc_filter`：安全规则体系。

### 配置中心
- `config`：系统/默认配置存储（多 type + scope）。

## 4. 待补全清单

- 前端每个页面/选项 -> 对应数据表字段/配置 key 的精确映射。
- 配置继承逻辑在后端创建/更新流程中的落地代码。
- 配置同步具体实现：Redis 通知 + 节点拉取差量协议。

## 5. 表结构目录（db.sql）

核心配置与业务表：
- task: 任务/异步作业
- site_conf_cache: 站点配置缓存
- user: 用户
- login_log: 登录日志
- region: 地域
- node: 节点
- node_monitor_log: 节点监控日志
- node_group: 节点组/线路组
- line: 节点线路关联
- op_log: 操作日志
- dnsapi: DNS API
- cert: 证书
- acl: ACL 规则
- cc_rule/cc_match/cc_filter: CC 规则
- package/package_group/merge_package_group: 套餐体系
- package_up/user_package/user_package_up: 套餐购买与附加包
- config: 系统/默认配置键值
- site/site_group/merge_site_group: 网站配置与分组
- stream/stream_group/merge_stream_group: 四层转发（原表）
- order: 订单
- job: 任务队列
- tlock: 锁表
- res_count: 资源统计
- captcha: 验证码
- api_key: API 密钥
- message/message_read/message_sub/message_send: 消息系统
- ip_switch_log: 线路切换日志
- lets_account: 证书账号
- cname_domains: CNAME 域名池

## 6. 关键配置键（config 表，按 type 分类）

### site_default_config（站点默认）
- http_listen-port
- https_listen-port
- https_listen-hsts
- https_listen-http2
- https_listen-force_ssl_enable
- https_listen-ssl_protocols
- https_listen-ssl_ciphers
- https_listen-ssl_prefer_server_ciphers
- balance_way
- cc_default_rule
- gzip_enable
- gzip_types
- websocket_enable
- backend_protocol
- backend_http_port
- backend_https_port
- proxy_timeout
- range
- proxy_cache
- proxy_http_version
- post_size_limit
- proxy_ssl_protocols
- ups_keepalive
- ups_keepalive_conn
- ups_keepalive_timeout

### stream_default_config（四层转发默认）
- listen_protocol
- balance_way
- proxy_protocol

### cert_default_config
- cert_default_type

### site / stream / site_stream（资源限制）
- related-config-min-limit
- related-config-max-times-limit
- black-ip-limit
- white-ip-limit
- max-domain-persite-limit
- listen-default-http-80
- clean_url
- clean_dir
- pre_cache_url
- pre_cache_timeout
- ip-unlock-max-limit
- ip-unlock-max-per-limit
- cc-rule-max-limit
- acl-max-limit
- download-access-log-limit
- download-access-log-tmp-dir
- download-access-log-retain
- custom-port-not-allow
- custom-port-allow

### nginx_config / openresty_config / error_page
- nginx-config-file
- openresty-config
- error-page

### system（系统级）
- keep-job-days / keep-login-log-days / keep-op-log-days / keep-task-log-days
- keep-access-log-days / keep-node-log-days / keep-traffic-history-days
- backup_rate / backup_keep_days / backup_dir
- max_site_stream_sync_one_time
- login_session_valid_time
- dns_config
- admin_domain / user_domain
- allow_register
- smtp / sms_config
- register_success_templ / forget_password_templ / email_captcha_templ
- register_require / user_agreement
- phone_captcha_templ
- alipay_id_auth
- dns_rs_protect
- node_health_check / node_max_failed
- record_repair / record_sync / record-repair-enable
- package_expire_close_site / traffic_excceed_close_site
- package_allow_upgrade / package_allow_downgrade
- system_info / auth_code / maintain / master_client_ip_header
- recharge
- auto_upgrade_agent
- delete_config_delayed
- notification-period
- traffic-exceed-notify / traffic-exceeding-notify
- package-expire-notify / package-expiring-notify
- cert-expire-notify / cert-expiring-notify
- cc-switch-notify
- bandwidth-exceed-notify / conn-exceed-notify
- notify-method
- sync-site-config-scope
- node_monitor_config
- https_cert / https_key

## 7. 站点默认应用规则（待实现）

创建站点时应用默认值：
- 若用户存在 site_default_config（scope_name=user, scope_id=uid）：使用用户默认，并对缺失项回退系统默认。
- 若用户无默认：使用系统默认（scope_name=global, scope_id=0）。

应用字段（映射）：
- http_listen-port -> site.http_listen
- https_listen-port -> site.https_listen
- balance_way -> site.balance_way
- backend_protocol -> site.backend_protocol
- cc_default_rule -> site.cc_default_rule
- 其余默认项进入 site.settings（按 https/backsource/cache/advanced 分类）

## 8. 转发默认应用规则（待实现）

创建转发时应用默认值：
- 若用户存在 stream_default_config（scope_name=user, scope_id=uid）：使用用户默认，并对缺失项回退系统默认。
- 若用户无默认：使用系统默认（scope_name=global, scope_id=0）。

应用字段（映射）：
- listen_protocol -> forward.settings.listen_protocol
- balance_way -> forward.settings.origin.balance_way
- proxy_protocol -> forward.settings.origin.proxy_protocol


## 9. ??????????

## 9. ??????????

????
- ?????????/??????????
- ????????site_default_config / stream_default_config / system ???
- ???????????????Redis ????????? 304 ???
- ????????????config_items?global/user scope??

????
- ???? -> ???/????????????????????????????????????DNS API?????/WAF/????/???/CC????/ACL????
- ???????EdgeConfig??????????????? L7 ??/??/??/?? + ?? WAF/ACL ????

????
- ?????????????config_items API ?? admin/user ?????
- ?????? API ?????????? 304??
- ??????????????????

?????
- ?????`api/services/sync_service.go`?`api/controllers/agent_controller.go`?`api/controllers/global_config_controller.go`?
- ?????`api/controllers/site_controller.go`?`api/controllers/forward_controller.go`?`api/controllers/cert_controller.go`?

???????
- ????`GET/POST /config_items`?
- ????`GET/POST /config_items`?user scope ??????


## 10. ????????????

### ???? -> ?????/sites/batch_update?
- ????
  - ?? -> site.user_package
  - ???? -> merge_site_group
  - DNS API -> site.dns_provider_id
- HTTP ??
  - ????/???? -> site.http_listen????????
- HTTPS ??
  - ????/???? -> site.https_listen????????
  - ?? HTTPS -> settings.https.force
  - HTTPS ???? -> settings.https.redirect_port
  - HSTS -> settings.https.hsts
  - HTTP2 -> settings.https.http2
  - OCSP Stapling -> settings.https.ocsp_stapling
  - HTTP3 -> settings.https.http3
  - SSL ??? -> settings.https.ssl_profile
- ????
  - ???? -> settings.origin.list
  - ???? -> settings.origin.conditions
  - ?????? -> settings.origin.health_check
  - ???? -> site.balance_way
- ????
  - ???? -> site.backend_protocol + settings.backsource.protocol
  - ????/Host/?? -> settings.backsource.{http_port,https_port,host_mode,host_custom,timeout,connect_timeout}
- ????
  - ????/??/?? -> settings.cache.{enable,preset,rules}
- ????
  - ???? -> site.cc_default_rule + settings.security.default_rule
  - ????/????? -> settings.security.{auto_switch,custom_rules}
  - ??????/???? -> settings.security.{black_time_mode,black_time_custom,white_time_mode,white_time_custom,bot}
  - ???? -> site.black_ip / site.white_ip + settings.security.{blacklist,whitelist}
  - ???? -> settings.security.shield_proxy
  - ???? -> site.block_region + settings.security.{region_mode,region_custom}
- ????
  - ACL/???/?? -> settings.access.{acl,hotlink,cors}
- ????
  - IPv6/Gzip/Websocket/?????? -> settings.advanced.{ipv6,gzip,websocket,search_origin}
  - ?????? -> settings.advanced.error_pages
  - URL ?? -> settings.advanced.url_redirects
  - ??/??? -> settings.advanced.{origin_headers,cdn_headers}
  - ACME ??/??/??/???? -> settings.advanced.{acme_backsource,realtime_return,realtime_send,log_request_header,log_response_header,log_request_body,body_limit}

????????????? site.settings????????????????????


### ???????/global_config -> DefaultConfig?
- ???? -> global_config.default_config.website
  - cache_enable/cache_ttl/gzip/waf_enable
- API ?? -> global_config.default_config.api
  - cache_enable(????)/gzip/waf_enable
- ???? -> global_config.default_config.download
  - cache_enable/gzip/waf_enable

### ?? WAF ???/global_config -> WAF?
- WAF ?? -> waf.enable
- ?????? -> waf.default_block_action
- IPSet ???? -> waf.auto_ipset_enable / waf.auto_ipset_threshold
- ????? -> waf.block_page_rate_limit_enable / waf.block_page_rate_limit / waf.block_page_traffic_free
- ??/????? -> waf.blacklist_timeout / waf.temp_whitelist_timeout
- ??????? -> waf.temp_whitelist_limit_total / waf.temp_whitelist_limit_url
- ???? -> waf.whitelist_ips / waf.blacklist_ips
- ???? -> waf.prevent_tls_handshake / waf.block_unbound_domain / waf.disable_ping
- ????? -> waf.default_page_protection / waf.default_page_protection_threshold
- ? CC ?? -> waf.anti_cc_type / waf.anti_cc_image_source / waf.anti_cc_image_custom_url / waf.anti_cc_debug
- ???? -> waf.cc_rule_auto_switch
- ???? -> waf.secret_key / waf.node_log_clean_strategy
- ?????? -> waf.well_known_protection_threshold
- ?????? -> waf.resource_protection_enable / waf.resource_protection_threshold / waf.resource_protection_block_timeout / waf.resource_protection_rules

### ???????/global_config -> Resources?
- ???? -> resources.website.*
  - min_limit / max_limit_multiplier / max_blacklist_ips / max_whitelist_ips
  - daily_url_purge_limit / daily_dir_purge_limit / daily_preload_limit
  - daily_unlock_ip_limit / unlock_ip_batch_limit
  - max_cc_rules_per_group / max_acl_rules
  - daily_log_download_limit / log_storage_dir / log_storage_hours
  - max_domains_per_site / default_listen_80
- ???? -> resources.forward.*
  - disabled_ports / min_limit / max_limit_multiplier / max_acl_rules
- ???? -> resources.public.*
  - disabled_custom_ports / allowed_custom_ports


### ?????L7 ?????
- ???? EdgeConfig?`api/services/config_service.go`
  - domains??????? -> EdgeDomain{name, upstream_key, load_balance_policy, headers, ssl_cert_data, ssl_key_data}
  - upstreams????????? -> EdgeUpstream{targets:[addr,weight]}
  - SSL?????? HTTPS????????? cert.domain???????????????
- ?????`cdn-edge-node/lua/config_loader.lua`
  - ?? `cdn_config.json`??? domain_map/upstream_map
  - ??????????
- ?????`cdn-edge-node/lua/access.lua`
  - ?? host ? domain_map??? upstream_key ? load_balance_policy
  - balancer ??????? `ngx.var.backend_target`
  - headers ?????
- HTTPS?`cdn-edge-node/lua/ssl_manager.lua`
  - ?? SNI ? domain_map??? ssl_cert_data/ssl_key_data ????

???L4 ???????????? stream/udp/tcp ????? nginx stream ??????


### ??????? WAF?
- EdgeConfig ?? `waf` ????? global_config?
- ?? `lua/waf.lua` ?????
  - ???waf.enable=false ???
  - ????waf.whitelist_ips ?????
  - ????waf.blacklist_ips ??? 403
  - ?? WAF ????????? Redis ??????


### CC ?????/rules/cc/*?
- cc_rule: ????name/des/data/enable/internal/is_show/sort?
- cc_match: ????name/des/data/enable/internal?
- cc_filter: ????name/des/type/within_second/max_req/extra/enable/internal?
- ???
  - GET /rules/cc/groups -> cc_rule ????? name/status?
  - GET /rules/cc/groups/:id -> ?? data.rules?????
  - GET /rules/cc/matchers -> cc_match ??
  - GET /rules/cc/filters -> cc_filter ??

?????
- ???????? CC ????/????? EdgeConfig ??? cc ???? waf.lua/anti_cc.lua ?????


### ACL ???/rules/acl?
- acl ??name/des/default_action/data/enable
- data?JSON ?? {ip, action}
- ???GET/POST/PUT/DELETE /rules/acl

?????ACL?
- EdgeConfig ?? `acl_default_action` + `acl_rules` ?????
- ??? access.lua ??? IP ??????? deny -> 403?????? default_action
- ????? CIDR/?????????


## Progress Log
- DB ???? MySQL?DSN ?? config.App.DBDSN??
- ??/???? API ??? DB ?????????????????????????
- Block log APIs ?? mock???????/?????
- BlockLogs ??????????????? /logs/block/* ???
- ?????????????????res.data.list/total??
- AutoMigrate ?? login_log/op_log ???
- ?????? login_log???/???????
- ?????? op_log????? GET/OPTIONS ?????
- ???????? uid ??????????
- ????????????????? /admin ????
- ??????????????stats/ranking??
- ??????????/?? config ??key: node_monitor_config??
- op_log ?????? path?FullPath ???? URL.Path??
- ??????? node_monitor_config ?????
- op_log ???? user/admin ????? role ?? type??
- ??????? op_log ???? GET/OPTIONS??
- ??????? API ???admin/user ?? + ??????
- ??????????????/user/logs/operation??
- request.js ????? API baseURL?admin/user??
- ?????????????????????
- API Key ???????????????????????
- ??????/??????????????
