worker_processes  auto; # Auto detect cores
worker_rlimit_nofile 65535; # High concurrency file descriptors
include conf/dynamic/main.conf;

events {
    worker_connections  10240; # High concurrency per worker
    use epoll;
    multi_accept on;
    include conf/dynamic/events.conf;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # --------------------------------------------------------
    # 1. Performance Tuning (Kernel/Network)
    # --------------------------------------------------------
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;
    keepalive_requests 10000;
    
    # --------------------------------------------------------
    # 2. JSON Logging (User Req #2) - Machine Parsable
    # --------------------------------------------------------
    log_format json_analytics escape=json
    '{'
      '"time_iso8601": "$time_iso8601",'
      '"remote_addr": "$remote_addr",'
      '"host": "$host",'
      '"request": "$request",'
      '"status": $status,'
      '"body_bytes_sent": $body_bytes_sent,'
      '"request_time": $request_time,'
      '"upstream_addr": "$upstream_addr",'
      '"upstream_response_time": "$upstream_response_time",'
      '"upstream_cache_status": "$upstream_cache_status",'
      '"http_referer": "$http_referer",'
      '"http_user_agent": "$http_user_agent",'
      '"scheme": "$scheme",'
      '"ssl_protocol": "$ssl_protocol",'
      '"ssl_cipher": "$ssl_cipher"'
    '}';

    access_log logs/access.json json_analytics;
    error_log  logs/error.log warn;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # --------------------------------------------------------
    # 3. Native Security Layers (User Req #4 - "C Layer")
    # --------------------------------------------------------
    
    # Limit Request Zone (High Frequency CC)
    # zone=cc_limit:10m (store ~160k IPs) rate=50r/s (standard baseline)
    limit_req_zone $binary_remote_addr zone=cc_limit:10m rate=50r/s;

    # Limit Connection Zone (L7 concurrent connections)
    limit_conn_zone $binary_remote_addr zone=addr_conn:10m;
    
    # Shared Dictionaries for Lua (Metrics & Config)
    lua_shared_dict metrics_store 20m;
    lua_shared_dict config_store 10m;
    lua_shared_dict waf_cache 10m;
    lua_shared_dict ip_blacklist 10m;
    lua_shared_dict limit_req_store 20m;
    lua_shared_dict cc_req_rate 20m;
    
    # Init Worker: Metrics & Config
    init_worker_by_lua_block {
        local config_loader = require "lua.config_loader"
        config_loader.init() 
    }
    include conf/dynamic/http_global.conf;
    include conf/dynamic/http.conf;

    server {
        listen 127.0.0.1:9100;
        server_name localhost;
        location /metrics {
            allow 127.0.0.1;
            deny all;
            content_by_lua_block {
                local metrics = require "lua.metrics"
                ngx.say(metrics.get_prometheus_data())
            }
        }
        location /stub_status {
            stub_status;
            allow 127.0.0.1;
            deny all;
        }
    }
}

stream {
    limit_conn_zone $binary_remote_addr zone=stream_conn:10m;
    include conf/dynamic/stream_global.conf;
    include conf/dynamic/stream.conf;
}
