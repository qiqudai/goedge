# ?????????????????????

## ????????

### ??
- ????????????????????????
- ???????????

### ????
- ??????????DNS API?ACL?CC ???/???/?????????????????????????????????

### ????
1) ?????????????????/??/??????
2) ?????????????HTTP/Stream ????
3) ?? Agent ??/????????????
4) `nginx -s reload` ??????????
5) ?? sync_state ? task_id?

### ???????OpenResty ????
- ???? Nginx/Stream ??????????
- ???? Lua ????????
- ????????????? + `auth_request`?
- ?????????? ipset/iptables + Agent ???

## ???????? / API / ?? / ???

### 1) ???? `/v1/sites`

#### ???????
- ?????????????????HTTPS ????????????
- ???????IP?????????????HTTPS ?????????????
- ??/???
  - ???????????????????
  - ???HTTP ???HTTPS ???????? HTTPS??????
  - ????????????????????IP??/??/????????
  - ????????????????????????
  - ???CC ???????????? CC ??????????????????
  - ?????ACL????CORS?
  - ???????????URL ???gzip?websocket?????Range??????
  - ACME?`/.well-known` ?????

#### API ?????????
```json
{
  "user_package": 1,
  "domain": "www.example.com api.example.com",
  "http_listen": {"port": "80"},
  "https_listen": {"port": "443", "cert": "1"},
  "backend_protocol": "http",
  "backend_http_port": "80",
  "backend": [{"addr": "1.1.1.1", "weight": 1, "state": "up"}],
  "balance_way": "rr",
  "health_check": {"enable": true, "protocol": "http", "host": "www.example.com", "path": "/", "status_code": "200 301 302", "interval": 10},
  "proxy_cache": [],
  "cc_default_rule": 10001,
  "acl": 1,
  "hotlink": {"enable": 0, "domain": "", "allow_empty": 1},
  "cors": {"enable": 0, "allow_origin": "*", "allow_methods": "GET POST", "allow_headers": "*", "allow_credentials": 1, "max_age": 1728000},
  "gzip_enable": 1,
  "websocket_enable": 0,
  "enable": 1
}
```

#### ????
- ???? -> ???? Nginx ??????????????
- HTTPS/???? -> ??????? reload?
- ?????? -> ?? ACL/CC ?????

#### ????
- ?? `server`/`upstream`/??/??/headers/ACL/CC/cors/gzip/websocket/url_rewrite ???
- ?? `nginx -s reload` ????

---

### 2) ??? `/v1/site-groups`

#### ???????
- ??????????
- ??/?????????

#### API ?????
```json
{"name": "??", "des": ""}
```

#### ????
- ??????????????????

#### ????
- ???????????????

---

### 3) ?? `/v1/certs`

#### ???????
- ????????????????????????
- ??????custom/lets/zerossl?????DNSAPI???/???
- ????????????

#### API ???????????
```json
{"name": "example.com", "type": "custom", "cert": "...", "key": "..."}
```

#### API ???????????
```json
{"name": "example.com", "type": "lets", "domain": "example.com"}
```

#### ????
- ????/?????????????
- ?????????????

#### ????
- ?? `ssl_certificate`/`ssl_certificate_key` ??????reload ???

---

### 4) DNS API `/v1/dnsapis`

#### ???????
- ?????????
- ??/?????????????????????

#### API ?????
```json
{"name": "dnspod", "type": "DNSPod.cn", "auth": {"DP_Id": "xxx", "DP_Key": "xxx"}}
```

#### ????
- ??????????/???????????

#### ????
- ??????

---

### 5) ?? ACL `/v1/acls`

#### ???????
- ?????????????????
- ???????ip/host/uri/ua/referer/country ????????????

#### API ?????
```json
{
  "name": "?????",
  "default_action": "reject",
  "data": [
    {"acl_action": "allow", "acl_matcher": {"country_iso_code": {"operator": "=", "value": "CN"}}}
  ]
}
```

#### ????
- ACL ?? -> ????/????????

#### ????
- ?? `geo`/`map`/`deny/allow` ?????? Lua?

---

### 6) CC ??? `/v1/cc-matchs`

#### ???????
- ?????????????ip/host/req_uri/ua/referer/country/isp ???

#### API ?????
```json
{"name": "??API", "data": {"uri": {"operator": "contain", "value": "/api"}}}
```

#### ????
- ????? -> ?????????

#### ????
- ??? `map` ??? `geo` ???

---

### 7) CC ??? `/v1/cc-filters`

#### ???????
- ???req_rate?302_challenge?browser_verify_auto?slide_filter?captcha_filter?click_filter?url_auth?delay_jump_filter?
- ????/?????/? URI ???
- URL ?? extra ???

#### API ?????
```json
{"name": "???", "type": "captcha_filter", "within_second": 60, "max_req": 5, "extra": {}}
```

#### ????
- ????? -> ?????????

#### ????
- ????`limit_req`/`limit_conn`?
- URL ???`secure_link` ? `auth_request`?
- ???/???`auth_request` ?????

---

### 8) CC ??? `/v1/cc-rules`

#### ???????
- ???????????????
- ???????????1????2????ipset/exit/log??

#### API ?????
```json
{
  "name": "5???",
  "sort": 100,
  "data": [{"action": "ipset", "matcher": "10022", "filter1": "10022", "filter2": "", "state": true}],
  "enable": 1,
  "is_show": 1
}
```

#### ????
- ????? -> ??????????

#### ????
- ???????????????

---

### 9) ???? `/v1/jobs`

#### ???????
- ??/?????URL/????????
- ??????? ID?IP?
- ???????????IP?URI??????????

#### API ???????? URL?
```json
[{"type": "clean_url", "data": {"url": "http://example.com/"}}]
```

#### API ?????????
```json
[{"type": "unlock_ip", "data": {"site_id": "327", "ip": "1.1.1.1", "key1": "site_id"}}]
```

#### ????
- ??????????????? reload?

#### ????
- ???/??????????????
- ???ipset ???? IP?
- ?????????????????????

---

### 10) ???? `/v1/streams`

#### ???????
- ???????/?????????????????
- ??/??????????????proxy protocol?????ACL?

#### API ?????
```json
{
  "user_package": 427,
  "listen": [{"protocol": "tcp", "port": "88"}],
  "backend_port": 88,
  "backend": [{"addr": "1.1.1.1", "weight": 1, "state": "up"}],
  "balance_way": "rr",
  "proxy_protocol": 0,
  "conn_limit": 0,
  "acl": {"default_action": "allow", "rule": []}
}
```

#### ????
- ???? -> ?? Stream ??????

#### ????
- ?? `stream` `server`/`upstream`/`proxy_pass`/ACL/conn_limit ??? reload?

---

### 11) ??? `/v1/stream-groups`

#### ???????
- ?? + ??/??????????

#### API ?????
```json
{"name": "??", "des": ""}
```

#### ????
- ????????????

#### ????
- ???????????????
